<!DOCTYPE html>
<html lang="en">    
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twibbon KBI</title>
<style>
body {
display: flex;
justify-content: center;
align-items: center;
height: 100vh;
background-color: #ffffff;
}
.container {
text-align: center;
}
.btn {
padding: 10px 20px;
font-size: 16px;
background-color: #007bff;
color: white;
border: none;
cursor: pointer;
border-radius: 5px;
}
.btn:hover {
background-color: #0056b3;
}
canvas {
border: 1px solid #ccc;
width: 500px;  /* Display size */
height: 500px; /* Display size */
}
</style>
<script src="https://cdn.jsdelivr.net/npm/micromodal/dist/micromodal.min.js"></script>
</head>
<body>
<div class="container">
<h2>Twibbon Komunitas Badut Indonesia</h2>
<p>
<input type="file" id="fileInput" accept="image/*">
</p>
<p>
<button class="btn" data-micromodal-trigger="modal-1" onclick="generateTwibbon()">Generate Twibbon</button>
</p>
<!--
<p>
<canvas id="canvas" width="1024" height="1024" style="display: none;"></canvas>
<canvas id="displayCanvas" width="300" height="300"></canvas>
</p>
<button class="btn" onclick="downloadImage()">Download Image</button>
-->

<script>
let img = new Image();
let frameImg = new Image();
frameImg.src = 'twibbon.png'; // Update with your frame image path
let displayCanvas, displayCtx, canvas, ctx;
let isDragging = false;
let startX, startY;
let imgX = 0, imgY = 0;
let imgScale = 1;
let initialDistance = 0;

function generateTwibbon() {
const fileInput = document.getElementById('fileInput');
canvas = document.getElementById('canvas');
ctx = canvas.getContext('2d');
displayCanvas = document.getElementById('displayCanvas');
displayCtx = displayCanvas.getContext('2d');

const file = fileInput.files[0];
if (file) {
const reader = new FileReader();
reader.onload = function(e) {
img.onload = function() {
drawImage();
};
img.src = e.target.result;
};
reader.readAsDataURL(file);

// Add event listeners for repositioning the image
displayCanvas.addEventListener('mousedown', startDragging);
displayCanvas.addEventListener('mousemove', dragImage);
displayCanvas.addEventListener('mouseup', stopDragging);
displayCanvas.addEventListener('mouseout', stopDragging);
displayCanvas.addEventListener('wheel', resizeImage);

// Add touch event listeners for mobile devices
displayCanvas.addEventListener('touchstart', startDragging);
displayCanvas.addEventListener('touchmove', dragImage);
displayCanvas.addEventListener('touchend', stopDragging);
displayCanvas.addEventListener('touchmove', handlePinch);
} else {
alert('Please upload an image file.');
}
}

function drawImage() {
// Calculate scale ratio between display and actual canvas
const scale = displayCanvas.width / canvas.width;

// Draw on the actual canvas
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.drawImage(img, imgX, imgY, img.width * imgScale, img.height * imgScale);
ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);

// Draw on the display canvas
displayCtx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);
displayCtx.drawImage(canvas, 0, 0, canvas.width * scale, canvas.height * scale);
}

function getOffset(event) {
if (event.touches) {
const touch = event.touches[0];
return {
x: touch.clientX - displayCanvas.getBoundingClientRect().left,
y: touch.clientY - displayCanvas.getBoundingClientRect().top
};
}
return {
x: event.offsetX,
y: event.offsetY
};
}

function startDragging(event) {
const scale = canvas.width / displayCanvas.width;
const offset = getOffset(event);
isDragging = true;
startX = offset.x * scale - imgX;
startY = offset.y * scale - imgY;
if (event.touches && event.touches.length === 2) {
initialDistance = getDistance(event.touches);
}
event.preventDefault(); // Prevent scrolling on touch devices
}

function dragImage(event) {
if (isDragging) {
const scale = canvas.width / displayCanvas.width;
const offset = getOffset(event);
imgX = offset.x * scale - startX;
imgY = offset.y * scale - startY;
drawImage();
event.preventDefault(); // Prevent scrolling on touch devices
}
}

function stopDragging(event) {
isDragging = false;
}

function resizeImage(event) {
if (event.deltaY < 0) {
imgScale *= 1.1;
} else {
imgScale /= 1.1;
}
drawImage();
event.preventDefault(); // Prevent zooming on touch devices
}

function handlePinch(event) {
if (event.touches.length === 2) {
const currentDistance = getDistance(event.touches);
if (initialDistance > 0) {
const scaleChange = currentDistance / initialDistance;
imgScale *= scaleChange;
initialDistance = currentDistance;
drawImage();
}
event.preventDefault(); // Prevent scrolling on touch devices
}
}

function getDistance(touches) {
const dx = touches[0].clientX - touches[1].clientX;
const dy = touches[0].clientY - touches[1].clientY;
return Math.sqrt(dx * dx + dy * dy);
}

function downloadImage() {
const link = document.createElement('a');
link.download = 'twibbon.png';
link.href = canvas.toDataURL('image/png');
link.click();
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {  
try {    
MicroModal.init({
awaitCloseAnimation: true,// set to false, to remove close animation
onShow: function(modal) {
console.log("micromodal open");
},
onClose: function(modal) {
console.log("micromodal close");
}
});    
} catch (e) {
console.log("micromodal error: ", e);
}  
});
</script>

<div class="modal micromodal-slide" id="modal-1" aria-hidden="true">
<div class="modal__overlay" tabindex="-1" data-micromodal-close>
<div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
<header class="modal__header">
<h2 class="modal__title">
Twibbon
</h2>
<button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
</header>
<div class="modal-content-content">
<div class="modal__content">
<p>
<canvas id="canvas" width="1024" height="1024" style="display: none;"></canvas>
<canvas id="displayCanvas" width="500" height="500"></canvas>
</p>
<button class="btn" onclick="downloadImage()">Download Image</button>
</div>
<footer class="modal__footer">
<button class="modal__btn" data-micromodal-close aria-label="Close this dialog window">Close</button>
</footer>
</div>
</div>
</div>
</div>

<button class="external" data-micromodal-trigger="modal-1">Open Modal Dialog</button>
</body>
</html>
